<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Profiling - Essential skills for reproducible research computing</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Profiling";
    var mkdocs_page_input_path = "numba/1.md";
    var mkdocs_page_url = "/numba/1/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Essential skills for reproducible research computing</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
    
<li>
          
            <li>
    <ul class="subnav">
    <li><span>UNIX Command Line</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/setup/">Setup</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/navigation/">Navigation</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/file_handling/">File Creation and Editing</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/redirection/">Redirection</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/pipes/">Piping</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/man_and_less/">man and less</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/uber/">Uber exercise</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/unix_cheat_sheet/">Cheat Sheet</a>
        
    </li>
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>(I)Python</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../python/python/">Python</a>
        
    </li>
    

        
            
    

        
            
    

        
            
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Software Licensing</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../openlicenses/openlicensing/">Open Licensing</a>
        
    </li>
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>git</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../git/git/">git</a>
        
    </li>
    

        
            
    <ul class="subnav">
    <li><span>GitHub</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../git/github1/">push and pull</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../git/merge/">merging</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../git/conflicts/">conflicts</a>
        
    </li>
    

        
    </ul>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../git/github2/">GitHub Collaboration</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../git/branching/">Branch and Merge</a>
        
    </li>
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Jupyter</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../jupyter/the_notebook/">Navigating the notebook</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../jupyter/1/">The Python Scientific Stack</a>
        
    </li>
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Laplace</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../laplace/1/">Elliptic PDEs</a>
        
    </li>
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Numba</span></li>

        
            
    
    <li class="toctree-l1 current">
        <a class="current" href="./">Profiling</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#intro-to-profiling">Intro to profiling</a></li>
                
                    <li><a class="toctree-l4" href="#tools">Tools</a></li>
                
                    <li><a class="toctree-l4" href="#some-bad-code">Some bad code</a></li>
                
                    <li><a class="toctree-l4" href="#using-cprofile">using cProfile</a></li>
                
                    <li><a class="toctree-l4" href="#using-line_profiler">using line_profiler</a></li>
                
                    <li><a class="toctree-l4" href="#profiling-on-the-command-line">Profiling on the command line</a></li>
                
                    <li><a class="toctree-l4" href="#timeit">timeit</a></li>
                
            
            </ul>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../2/">Intro to JIT</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../3/">Numba Internals</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../4/">CFD Intro</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../5/">Cavity Flow</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../6/">vectorize</a>
        
    </li>
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>References</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../references/">References</a>
        
    </li>
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Resources and Tips</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../resources/">Resources</a>
        
    </li>
    

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Essential skills for reproducible research computing</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Numba &raquo;</li>
        
      
    
    <li>Profiling</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="intro-to-profiling">Intro to profiling</h1>
<p>Python's dirty little secret is that it can be made to run pretty fast.  </p>
<p>The bare-metal HPC people will be angrily tweeting at me now, or rather, they would be if they could get their wireless drivers working.</p>
<p>Still, there are some things you <em>really</em> don't want to do in Python.  Nested loops are usually a bad idea.  But often you won't know where your code is slowing down just by looking at it and trying to accelerate everything can be a waste of time.  (Developer time, that is, both now and in the future: you incur technical debt if you unintentionally obfuscate code to make it faster when it doesn't need to be).</p>
<p>The first step is always to find the bottlenecks in your code, via <em>profiling</em>: analyzing your code by measuring the execution time of its parts.</p>
<h2 id="tools">Tools</h2>
<ol>
<li><code>cProfile</code></li>
<li><a href="https://github.com/rkern/line_profiler"><code>line_profiler</code></a></li>
<li><code>timeit</code></li>
</ol>
<p><strong>Note</strong>:
If you haven't already installed it, you can do</p>
<pre><code class="console">conda install line_profiler
</code></pre>

<p>or</p>
<pre><code class="console">pip install line_profiler
</code></pre>

<h2 id="some-bad-code">Some bad code</h2>
<p>Here's a bit of code guaranteed to perform poorly: it sleeps for 1.5 seconds after doing any work! We will profile it and see where we might be able to help.</p>
<pre><code class="python">import numpy
from time import sleep

def bad_call(dude):
    sleep(.5)

def worse_call(dude):
    sleep(1)

def sumulate(foo):
    if not isinstance(foo, int):
        return

    a = numpy.random.random((1000, 1000))
    a @ a

    ans = 0
    for i in range(foo):
        ans += i

    bad_call(ans)
    worse_call(ans)

    return ans
</code></pre>

<pre><code class="python">sumulate(150)
</code></pre>

<pre><code>11175
</code></pre>
<h2 id="using-cprofile">using <code>cProfile</code></h2>
<p><a href="https://docs.python.org/3.4/library/profile.html#module-cProfile"><code>cProfile</code></a> is the built-in profiler in Python (available since Python 2.5).  It provides a function-by-function report of execution time. First import the module, then usage is simply a call to <code>cProfile.run()</code> with your code as argument. It will print out a list of all the functions that were called, with the number of calls and the time spent in each.</p>
<pre><code class="python">import cProfile
</code></pre>

<pre><code class="python">cProfile.run('sumulate(150)')
</code></pre>

<pre><code>         10 function calls in 1.549 seconds

   Ordered by: standard name

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    0.023    0.023    1.549    1.549 &lt;ipython-input-1-ab37b7e7eed9&gt;:10(sumulate)
        1    0.000    0.000    0.501    0.501 &lt;ipython-input-1-ab37b7e7eed9&gt;:4(bad_call)
        1    0.000    0.000    1.001    1.001 &lt;ipython-input-1-ab37b7e7eed9&gt;:7(worse_call)
        1    0.000    0.000    1.549    1.549 &lt;string&gt;:1(&lt;module&gt;)
        1    0.000    0.000    1.549    1.549 {built-in method builtins.exec}
        1    0.000    0.000    0.000    0.000 {built-in method builtins.isinstance}
        2    1.502    0.751    1.502    0.751 {built-in method time.sleep}
        1    0.000    0.000    0.000    0.000 {method 'disable' of '_lsprof.Profiler' objects}
        1    0.024    0.024    0.024    0.024 {method 'random_sample' of 'mtrand.RandomState' objects}
</code></pre>
<p>You can see here that when our code <code>sumulate()</code> executes, it spends almost all its time in the method <code>time.sleep</code> (a bit over 1.5 seconds).</p>
<p>If your program is more complicated that this cute demo, you'll have a hard time parsing the long output of <code>cProfile</code>. In that case, you may want a profiling visualization tool, like <a href="https://jiffyclub.github.io/snakeviz/">SnakeViz</a>. But that is outside the scope of this tutorial.</p>
<h2 id="using-line_profiler">using <code>line_profiler</code></h2>
<p><code>line_profiler</code> offers more granular information thatn <code>cProfile</code>: it will give timing information about each line of code in a profiled function.</p>
<p>Load the <code>line_profiler</code> extension</p>
<pre><code class="python">%load_ext line_profiler
</code></pre>

<h3 id="for-a-pop-up-window-with-results-in-notebook">For a pop-up window with results in notebook:</h3>
<p>IPython has an <code>%lprun</code> magic to profile specific functions within an executed statement. Usage:
<code>%lprun -f func_to_profile &lt;statement&gt;</code> (get more help by running <code>%lprun?</code> in IPython).</p>
<h3 id="profiling-two-functions">Profiling two functions</h3>
<pre><code class="python">%lprun -f bad_call -f worse_call sumulate(13)
</code></pre>

<h3 id="write-results-to-a-text-file">Write results to a text file</h3>
<pre><code class="python">%lprun -T timings.txt -f sumulate sumulate(12)
</code></pre>

<pre><code>*** Profile printout saved to text file 'timings.txt'.
</code></pre>
<pre><code class="python">%load timings.txt
</code></pre>

<p>Let's break down what these results are telling us. </p>
<p><code>Line #</code> corresponds to the line in a given script or notebook cell. To toggle line numbers in a code cell, hit <code>l</code> in command mode.</p>
<p><code>Hits</code> shows how many times a given line was encountered as a result of running the <code>sumulate</code> function. You can see that most lines in <code>sumulate</code> were hit only once, while the lines in the <code>for</code> loop were hit several times. </p>
<p><code>Time</code> is the amount of time spent, in total, on a given line. Note at the top of the profiling report that the time unit here is microseconds. </p>
<p><code>Per hit</code> is the amount of time, on average, each <code>hit</code> on a given line took. This is the same as the <code>Time</code> column for lines that were only hit once, but you can see the <code>Per hit</code> time has more meaning in the <code>for</code> loop lines.</p>
<p><code>% Time</code> is what we are really interested in. It tells us what percentage of the total run time of <code>sumulate</code> was spent on a given line. There are lots of ways to optimize all sorts of operations, but you should focus your time and energy on optimizing the code that is costing you the most time. 
You <em>could</em> try to further optimize Python's builtin matrix multiplication to get the <code>a @ a</code> to operate a little bit faster.  You might even shave off a microsecond (although probably not). But who cares? That matrix multiply takes up 2% of runtime. Focus your efforts on the expensive parts, which here are <code>bad_call</code> and <code>worse_call</code>.</p>
<h2 id="profiling-on-the-command-line">Profiling on the command line</h2>
<p>Open file, add <code>@profile</code> decorator to any function you want to profile, then run</p>
<pre><code class="console">kernprof -l script_to_profile.py
</code></pre>

<p>which will generate <code>script_to_profile.py.lprof</code> (pickled result).  To view the results, run</p>
<pre><code class="console">python -m line_profiler script_to_profile.py.lprof
</code></pre>

<pre><code class="python">from IPython.display import IFrame
</code></pre>

<pre><code class="python">IFrame('http://localhost:8888/terminals/1', width=800, height=700)
</code></pre>

<pre><code>    &lt;iframe
        width="800"
        height="700"
        src="http://localhost:8888/terminals/1"
        frameborder="0"
        allowfullscreen
    &gt;&lt;/iframe&gt;
</code></pre>
<h2 id="timeit"><code>timeit</code></h2>
<p><code>timeit</code> is not perfect, but it is helpful.  </p>
<p>Potential concerns re: <code>timeit</code></p>
<ul>
<li>Returns minimum time of run</li>
<li>Only runs benchmark 3 times</li>
<li>It disables garbage collection</li>
</ul>
<pre><code class="python">python -m timeit -v &quot;print(42)&quot;
</code></pre>

<pre><code class="python">python -m timeit -r 25 &quot;print(42)&quot;
</code></pre>

<pre><code class="python">python -m timeit -s &quot;gc.enable()&quot; &quot;print(42)&quot;
</code></pre>

<h3 id="line-magic">Line magic</h3>
<pre><code class="python">%timeit x = 5
</code></pre>

<pre><code>100000000 loops, best of 3: 11.3 ns per loop
</code></pre>
<h3 id="cell-magic">Cell magic</h3>
<pre><code class="python">%%timeit
x = 5
y = 6
x + y
</code></pre>

<pre><code>10000000 loops, best of 3: 32.9 ns per loop
</code></pre>
<p>The <code>-q</code> flag quiets output.  The <code>-o</code> flag allows outputting results to a variable.  The <code>-q</code> flag sometimes disagrees with OSX so please remove it if you're having issues.</p>
<pre><code class="python">a = %timeit -qo x = 5
</code></pre>

<pre><code class="python">print(a.all_runs)
</code></pre>

<pre><code>[1.1260504741221666, 1.1415640730410814, 1.1300840568728745]
</code></pre>
<pre><code class="python">print(a.best)
</code></pre>

<pre><code>1.1260504741221666e-08
</code></pre>
<pre><code class="python">print(a.worst)
</code></pre>

<pre><code>4.5797787606716156e-07
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../2/" class="btn btn-neutral float-right" title="Intro to JIT">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../laplace/1/" class="btn btn-neutral" title="Elliptic PDEs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />Content is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. <br> Code is licensed under BSD 3-Clause.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a> and deployed using <a href="https://drdoctr.github.io/doctr">doctr</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../../laplace/1/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../2/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</body>
</html>
