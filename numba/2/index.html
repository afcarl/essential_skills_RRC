<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Intro to JIT - Essential skills for reproducible research computing</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Intro to JIT";
    var mkdocs_page_input_path = "numba/2.md";
    var mkdocs_page_url = "/numba/2/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Essential skills for reproducible research computing</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>UNIX Command Line</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../nix/navigation/">Navigation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../nix/file_handling/">File Creation and Editing</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../nix/redirection/">Redirection</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../nix/pipes/">Piping</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../nix/man_and_less/">man and less</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../nix/uber/">Uber exercise</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>(I)Python</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../python/">Python</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>git</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../git/git/">git</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>GitHub</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../git/github1/">push and pull</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../git/merge/">merging</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../git/conflicts/">conflicts</a>
        
    </li>

        
    </ul>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Jupyter</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../jupyter/the_notebook/">Navigating the notebook</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../jupyter/1/">The Python Scientific Stack</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Numba</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../1/">Profiling</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Intro to JIT</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#using-jit">Using jit</a></li>
                
                    <li><a class="toctree-l4" href="#array-sum">Array sum</a></li>
                
            
                <li class="toctree-l3"><a href="#lets-get-started">Let's get started</a></li>
                
                    <li><a class="toctree-l4" href="#as-a-function-call">As a function call</a></li>
                
                    <li><a class="toctree-l4" href="#more-commonly-as-a-decorator">(more commonly) As a decorator</a></li>
                
                    <li><a class="toctree-l4" href="#how-does-this-compare-to-numpy">How does this compare to NumPy?</a></li>
                
                    <li><a class="toctree-l4" href="#when-does-numba-compile-things">When does numba compile things?</a></li>
                
                    <li><a class="toctree-l4" href="#your-turn">Your turn!</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../3/">Numba Internals</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../4/">CFD Intro</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../5/">Cavity Flow</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../6/">vectorize</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Essential skills for reproducible research computing</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Numba &raquo;</li>
        
      
    
    <li>Intro to JIT</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="using-jit">Using <code>jit</code></h1>
<p>We know how to find hotspots now, how do we improve their performance?</p>
<p>We <code>jit</code> them!</p>
<p>We'll start with a trivial example but get to some more realistic applications shortly.</p>
<h3 id="array-sum">Array sum</h3>
<p>The function below is a naive <code>sum</code> function that sums all the elements of a given array.</p>
<pre><code class="python">def sum_array(inp):
    J, I = inp.shape

    #this is a bad idea
    mysum = 0
    for j in range(J):
        for i in range(I):
            mysum += inp[j, i]

    return mysum
</code></pre>

<pre><code class="python">import numpy
</code></pre>

<pre><code class="python">arr = numpy.random.random((300, 300))
</code></pre>

<p>First hand the array <code>arr</code> off to <code>sum_array</code> to make sure it works (or at least doesn't error out)</p>
<pre><code class="python">sum_array(arr)
</code></pre>

<pre><code>45102.033677230997
</code></pre>
<p>Now run and save <code>timeit</code> results of <code>sum_array</code> as a baseline to compare against.</p>
<pre><code class="python">plain = %timeit -o sum_array(arr)
</code></pre>

<pre><code>100 loops, best of 3: 14.7 ms per loop
</code></pre>
<h1 id="lets-get-started">Let's get started</h1>
<pre><code class="python">from numba import jit
</code></pre>

<p><strong>Note</strong>: There are two ways to <code>jit</code> a function. These are just two ways of doing the same thing.  You can choose whichever you prefer.</p>
<h2 id="as-a-function-call">As a function call</h2>
<pre><code class="python">sum_array_numba = jit()(sum_array)
</code></pre>

<p>What's up with the weird double <code>()</code>s?  We'll cover that in a little bit.</p>
<p>Now we have a new function, called <code>sum_array_numba</code> which is the <code>jit</code>ted version of <code>sum_array</code>. 
We can again make sure that it works (and hopefully produces the same result as <code>sum_array</code>).</p>
<pre><code class="python">sum_array_numba(arr)
</code></pre>

<pre><code>45102.033677231
</code></pre>
<p>Good, that's the same result as the first version, so nothing has gone horribly wrong.  </p>
<p>Now let's time and save these results.</p>
<pre><code class="python">jitted = %timeit -o sum_array_numba(arr)
</code></pre>

<pre><code>10000 loops, best of 3: 73.9 µs per loop
</code></pre>
<p>Wow. 73.7 µs is a lot faster than 15.5 ms... How much faster?  Let's see.</p>
<pre><code class="python">plain.best / jitted.best
</code></pre>

<pre><code>198.80740381645145
</code></pre>
<p>So, a factor of 210x.  Not too shabby.  But we're comparing the best runs, what about the worst runs?</p>
<pre><code class="python">plain.worst / jitted.worst
</code></pre>

<pre><code>278.7481542534447
</code></pre>
<p>Yeah, that's still an incredible speedup.</p>
<h2 id="more-commonly-as-a-decorator">(more commonly) As a decorator</h2>
<p>The second way to <code>jit</code> a function is to use the <code>jit</code> decorator.  This is a very easy syntax to handle and makes applying <code>jit</code> to a function trivial. </p>
<p>Note that the only difference in terms of the outcome (compared to the other <code>jit</code> method) is that there will be only one function, called <code>sum_array</code> that is a Numba <code>jit</code>ted function. The "original" <code>sum_array</code> will no longer exist, so this method, while convenient, doesn't allow you to compare results between "vanilla" and <code>jit</code>ted Python.</p>
<p>When should you use one or the other? That's up to you. If I'm investigating whether Numba can help, I use <code>jit</code> as a function call, so I can compare results. Once I've decided to use Numba, I stick with the decorator syntax since it's much prettier (and I don't care if the "original" function is available).</p>
<pre><code class="python">@jit
def sum_array(inp):
    I, J = inp.shape

    mysum = 0
    for i in range(I):
        for j in range(J):
            mysum += inp[i, j]

    return mysum
</code></pre>

<pre><code class="python">sum_array(arr)
</code></pre>

<pre><code>45102.033677231
</code></pre>
<p>So again, we can see that we have the same result.  That's good.  And timing?</p>
<pre><code class="python">%timeit sum_array(arr)
</code></pre>

<pre><code>10000 loops, best of 3: 73.8 µs per loop
</code></pre>
<p>As expected, more or less identical to the first <code>jit</code> example.</p>
<h2 id="how-does-this-compare-to-numpy">How does this compare to NumPy?</h2>
<p>NumPy, of course, has built in methods for summing arrays, how does Numba stack up against those?</p>
<pre><code class="python">%timeit arr.sum()
</code></pre>

<pre><code>10000 loops, best of 3: 33.9 µs per loop
</code></pre>
<p>Right. Remember, NumPy has been hand-tuned over many years to be very, very good at what it does. For simple operations, Numba is not going to outperform it, but when things get more complex Numba can save the day. </p>
<p>Also, take a moment to appreciate that our <code>jit</code>ted code, which was compiled on-the-fly is offering performance in the same order of magnitude as NumPy.  That's pretty incredible.</p>
<h2 id="when-does-numba-compile-things">When does <code>numba</code> compile things?</h2>
<p><code>numba</code> is a just-in-time (hence, <code>jit</code>) compiler.  The very first time you run a <code>numba</code> compiled function, there will be a little bit of overhead for the compilation step to take place.  In practice, this is usually not noticeable. You may get a message from <code>timeit</code> that one "run" was much slower than most; this is due to the compilation overhead. </p>
<h2 id="your-turn"><a href="../exercises/02.Intro.to.JIT.exercises.ipynb#JIT-Exercise">Your turn!</a></h2>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../3/" class="btn btn-neutral float-right" title="Numba Internals">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../1/" class="btn btn-neutral" title="Profiling"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />Content is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. <br> Code is licensed under BSD 3-Clause.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../1/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../3/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>
      <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</body>
</html>
