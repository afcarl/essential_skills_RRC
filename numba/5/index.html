<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Cavity Flow - Essential skills for reproducible research computing</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Cavity Flow";
    var mkdocs_page_input_path = "numba/5.md";
    var mkdocs_page_url = "/numba/5/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Essential skills for reproducible research computing</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
    
<li>
          
            <li>
    <ul class="subnav">
    <li><span>UNIX Command Line</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/navigation/">Navigation</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/file_handling/">File Creation and Editing</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/redirection/">Redirection</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/pipes/">Piping</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/man_and_less/">man and less</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../nix/uber/">Uber exercise</a>
        
    </li>
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>(I)Python</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../python/python/">Python</a>
        
    </li>
    

        
            
    

        
            
    

        
            
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>git</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../git/git/">git</a>
        
    </li>
    

        
            
    <ul class="subnav">
    <li><span>GitHub</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../git/github1/">push and pull</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../git/merge/">merging</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../git/conflicts/">conflicts</a>
        
    </li>
    

        
    </ul>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Jupyter</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../jupyter/the_notebook/">Navigating the notebook</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../jupyter/1/">The Python Scientific Stack</a>
        
    </li>
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Laplace</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../../laplace/1/">Elliptic PDEs</a>
        
    </li>
    

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Numba</span></li>

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../1/">Profiling</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../2/">Intro to JIT</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../3/">Numba Internals</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../4/">CFD Intro</a>
        
    </li>
    

        
            
    
    <li class="toctree-l1 current">
        <a class="current" href="./">Cavity Flow</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#application-cavity-flow">Application: Cavity Flow</a></li>
                
                    <li><a class="toctree-l4" href="#save-numpy-answers-for-comparison">Save NumPy answers for comparison</a></li>
                
                    <li><a class="toctree-l4" href="#where-is-the-bottleneck">Where is the bottleneck?</a></li>
                
                    <li><a class="toctree-l4" href="#exercise-speed-up-the-ppe">Exercise: Speed up the PPE</a></li>
                
                    <li><a class="toctree-l4" href="#one-more-bit-of-optimization">One more bit of optimization?</a></li>
                
            
            </ul>
        
    </li>
    

        
            
    
    <li class="toctree-l1 ">
        <a class="" href="../6/">vectorize</a>
        
    </li>
    

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Essential skills for reproducible research computing</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Numba &raquo;</li>
        
      
    
    <li>Cavity Flow</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="application-cavity-flow">Application: Cavity Flow</h1>
<p>One of the most common validation cases in CFD is the lid-driven cavity flow.  We take a square cavity filled with a fluid and set the velocity of the lid to some constant value.  The flow within the cavity is driven by the lid, a spiral flow pattern develops and two distinctive pressure zones are visible in the upper corners against the lid.</p>
<p><img src='../figures/drivencavity.svg' width=350></p>
<pre><code class="python">import numpy
</code></pre>

<p>The Poisson equation is an elliptic PDE which almost always means using an iterative solver.  We're going to use the Jacobi method.  There are better ways, but that's beside the point.  </p>
<p>Here's the pressure Poisson equation:</p>
<p>
<script type="math/tex; mode=display">\begin{align}
p_{i,j}^{n+1} &= \frac{1}{4}\left(p_{i+1,j}^{n}+p_{i-1,j}^{n}+p_{i,j+1}^{n}+p_{i,j-1}^{n}\right) \\
&-\frac{\rho \Delta x}{16} \left( \frac{2}{\Delta t} \left(u_{i+1,j} - u_{i-1,j} + v_{i,j+1} - v_{i,j-1}\right) \right . \\
&-\frac{2}{\Delta x}\left(u_{i,j+1} - u_{i,j-1} \right) \left(v_{i+1,j} - v_{i-1,j} \right) \\
&- \left . \frac{\left(u_{i+1,j} - u_{i-1,j} \right)^2}{\Delta x} 
- \frac{ \left(v_{i,j+1} - v_{i,j-1} \right)^2 }{\Delta x} \right) \\
\end{align}</script>
</p>
<p>That looks a little nasty, but we only care about the top line when we iterate, since the bottom three lines depend only on values that don't change when we're correcting the pressure field.  Because it doesn't change, we break it out into a separate function.</p>
<pre><code class="python">def velocity_term(b, rho, dt, u, v, dx):
    b[1:-1, 1:-1] = (
        rho * dx / 16 *
        (2 / dt * (u[1:-1, 2:] -
                    u[1:-1, :-2] +
                    v[2:, 1:-1] -
                    v[:-2, 1:-1]) -
        2 / dx * (u[2:, 1:-1] - u[:-2, 1:-1]) *
                 (v[1:-1, 2:] - v[1:-1, :-2]) -
        (u[1:-1, 2:] - u[1:-1, :-2])**2 / dx -
        (v[2:, 1:-1] - v[:-2, 1:-1])**2 / dx)
                     )

    return b
</code></pre>

<p>Now, to calculate the pressure field, we pass in the original pressure field, the value <code>b</code> (which is the result of the <code>velocity_term</code> function above) and a target value for difference between two iterates.  We repeatedly update the pressure field until the difference of the L2 norm between two successive iterations is less than that target value.</p>
<pre><code class="python">def pressure_poisson(p, b, l2_target):
    iter_diff = l2_target + 1
    n = 0
    while iter_diff &gt; l2_target and n &lt;= 500:

        pn = p.copy()
        p[1:-1,1:-1] = (.25 * (pn[1:-1, 2:] +
                               pn[1:-1, :-2] +
                               pn[2:, 1:-1] +
                               pn[:-2, 1:-1]) -
                               b[1:-1, 1:-1])

        p[:, 0] = p[:, 1]   #dp/dx = 0 at x = 0
        p[:, -1] = p[:, -2] #dp/dx = 0 at x = 2
        p[0, :] = p[1, :]   #dp/dy = 0 at y = 0
        p[-1, :] = 0        #p = 0 at y = 2

        if n % 10 == 0:
            iter_diff = numpy.sqrt(numpy.sum((p - pn)**2)/numpy.sum(pn**2))

        n += 1

    return p
</code></pre>

<p>In the interests of brevity, we're only going to worry about the pressure Poisson solver.  The rest of the 2D Navier-Stokes solution is encapsulated in the function <code>cavity_flow</code>, which we've prepared ahead of time and saved in a helper file. If you want to dig deeper into how the <code>cavity_flow</code> function works, check out "The 12 Steps to Navier-Stokes" at <a href="https://github.com/barbagroup/CFDPython">CFD Python</a>.</p>
<p>For now, though, we just need to import the function:</p>
<pre><code class="python">from snippets.ns_helper import cavity_flow
</code></pre>

<p>We'll also load up <a href="https://docs.python.org/3/library/pickle.html">pickled</a> initial conditions, so we can reliably compare final solutions.</p>
<pre><code class="python">import pickle
</code></pre>

<pre><code class="python">def run_cavity():
    nx = 41
    ny = 41
    with open('IC.pickle', 'rb') as f:
        u, v, p, b = pickle.load(f)

    dx = 2 / (nx - 1)
    dt = .005
    nt = 1000

    u, v, p = cavity_flow(u, v, p, nt, dt, dx, 
                         velocity_term, 
                         pressure_poisson, 
                         rtol=1e-4)

    return u, v, p
</code></pre>

<p>So what does this all do?  Let's check it out.</p>
<pre><code class="python">u, v, p = run_cavity()
</code></pre>

<pre><code class="python">%matplotlib inline
from snippets.ns_helper import quiver_plot
</code></pre>

<pre><code class="python">quiver_plot(u, v, p)
</code></pre>

<p><img alt="png" src="../04.1.Cavity_Flow_execute_files/04.1.Cavity_Flow_execute_18_0.png" /></p>
<h4 id="save-numpy-answers-for-comparison">Save NumPy answers for comparison</h4>
<p>This will create a binary file, saved to disk as <code>numpy_ans.pickle</code> that contains the values of <code>u</code>, <code>v</code>, and <code>p</code>. </p>
<pre><code class="python">with open('numpy_ans.pickle', 'wb') as f:
    pickle.dump((u, v, p), f)
</code></pre>

<p>Let's profile the <code>cavity_flow</code> function and see if there's a specific place that's really hurting our performance.</p>
<pre><code class="python">%timeit run_cavity()
</code></pre>

<pre><code>1 loop, best of 3: 462 ms per loop
</code></pre>
<p>Remember that we need to load the <code>line_profiler</code> extension before we can use the <code>lprun</code> magic.</p>
<pre><code class="python">%load_ext line_profiler
</code></pre>

<pre><code class="python">%lprun -f cavity_flow run_cavity()
</code></pre>

<h2 id="where-is-the-bottleneck">Where is the bottleneck?</h2>
<p>Clearly the PPE is the problem here, so let's use <code>numba</code> to rewrite it.  </p>
<h2 id="exercise-speed-up-the-ppe"><a href="../exercises/05.Cavity.Flow.Exercises.ipynb#Exercise-1">Exercise: Speed up the PPE</a></h2>
<pre><code class="python">from numba import jit
</code></pre>

<pre><code class="python">%load snippets/ppe_numba.py
</code></pre>

<p>Since we have redefined the <code>pressure_poisson</code> function, we can run <code>run_cavity</code> again and we'll be using the new and improved <code>jit</code>ted PPE. </p>
<p>We don't want to overwrite our results, so we can choose different variable names to store the final velocity and pressure fields.</p>
<pre><code class="python">u_numba, v_numba, p_numba = run_cavity()
</code></pre>

<p>We use <code>numpy.allclose</code> to check that each value of the Python and Numba fields match to within a specified tolerance (the default tolerance is 1<script type="math/tex">\tt{E}^-</script>08).</p>
<pre><code class="python">assert numpy.allclose(p, p_numba)
assert numpy.allclose(u, u_numba)
assert numpy.allclose(v, v_numba)
</code></pre>

<p>If there were no errors raised by the previous cell, then the two answers match.  Hooray! 
If the answers match, we should see the same plot as above.  If they don't match, we can also check the plot to see if we're just a little bit off or completely wrong (although that can be hard to judge sometimes).</p>
<pre><code class="python">quiver_plot(u_numba, v_numba, p_numba)
</code></pre>

<p><img alt="png" src="../04.1.Cavity_Flow_execute_files/04.1.Cavity_Flow_execute_35_0.png" /></p>
<p>And now we can check to see how much the performance has been improved:</p>
<pre><code class="python">%timeit run_cavity()
</code></pre>

<pre><code>1 loop, best of 3: 460 ms per loop
</code></pre>
<p>Not as spectacular as some of the other examples, but remember, we started off using NumPy arrays, not regular nested Python loops, so this is still a very respectable speedup.  </p>
<p>Now if we re-profile the code, we can see how the runtime percentages have shifted around the improved PPE.  It's almost certainly going to remain the most expensive part of the solve, but it should be a smaller percentage overall.</p>
<pre><code class="python">%lprun -f cavity_flow run_cavity()
</code></pre>

<h2 id="one-more-bit-of-optimization">One more bit of optimization?</h2>
<p>As we improve the performance of the Pressure Poisson function, the profiling results will change and indicate other possible hotspots that we want to improve. It can be hard to know when to <em>stop</em> improving, to recognize that the gains are not worth what you are investing in rewriting code. </p>
<p>In the profile above (after rewriting the PPE) you'll notice that the <code>velocity_term</code> now occupies a larger percentage of the total run time. Here's a rewritten version of <code>velocity_term</code> that makes use of Numba so you can compare how much more performance we might be able to eke out of this simple cavity flow solver.</p>
<pre><code class="python">@jit(nopython=True)
def velocity_term(b, rho, dt, u, v, dx):
    J, I = b.shape

    for i in range(1, I):
        for j in range(1, J):
            b[j, i] = (
            rho * dx / 16 * 
            (2 / dt * (u[j, i + 1] - 
                      u[j, i - 1] + 
                      v[j + 1, i] - 
                      v[j - 1, i]) - 
            2 / dx * (u[j + 1, i] - u[j - 1, i]) * 
                     (v[j, i + 1] - v[j, i - 1]) - 
            (u[j, i + 1] - u[j, i - 1])**2 / dx - 
            (v[j + 1, i] - v[j - 1, i])**2 / dx)
            )
    return b
</code></pre>

<pre><code class="python">%timeit run_cavity()
</code></pre>

<pre><code>1 loop, best of 3: 415 ms per loop
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../6/" class="btn btn-neutral float-right" title="vectorize">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../4/" class="btn btn-neutral" title="CFD Intro"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />Content is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. <br> Code is licensed under BSD 3-Clause.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../4/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../6/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</body>
</html>
